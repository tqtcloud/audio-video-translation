# TOSèµ„æºæ¸…ç†è§£å†³æ–¹æ¡ˆ

## é—®é¢˜èƒŒæ™¯

åœ¨ä½¿ç”¨ç«å±±äº‘TOSå¯¹è±¡å­˜å‚¨å¤„ç†éŸ³é¢‘/è§†é¢‘ç¿»è¯‘ä»»åŠ¡æ—¶ï¼Œå‘ç°äº†ä¸€ä¸ªé‡è¦çš„èµ„æºæ³„æ¼é—®é¢˜ï¼š
- æ–‡ä»¶ä¸Šä¼ åˆ°TOSåï¼Œå¤„ç†å®Œæˆåä¸ä¼šè‡ªåŠ¨åˆ é™¤
- å³ä½¿ä¸­é—´å¤„ç†æ­¥éª¤å‡ºç°é—®é¢˜ï¼Œä¸Šä¼ çš„æ–‡ä»¶ä¹Ÿä¼šæ®‹ç•™åœ¨TOSä¸­
- é•¿æœŸç§¯ç´¯ä¼šå¯¼è‡´ä¸å¿…è¦çš„å­˜å‚¨è´¹ç”¨

## è§£å†³æ–¹æ¡ˆæ¦‚è¿°

å®ç°äº†ä¸€å¥—å®Œæ•´çš„TOSèµ„æºç”Ÿå‘½å‘¨æœŸç®¡ç†æœºåˆ¶ï¼š

### 1. **å³æ—¶æ¸…ç†æœºåˆ¶**
- æ¯æ¬¡å¤„ç†å®Œæˆåè‡ªåŠ¨åˆ é™¤ä¸Šä¼ çš„ä¸´æ—¶æ–‡ä»¶
- æ— è®ºå¤„ç†æˆåŠŸè¿˜æ˜¯å¤±è´¥éƒ½ä¼šæ‰§è¡Œæ¸…ç†
- ä½¿ç”¨try/finallyç¡®ä¿æ¸…ç†åŠ¨ä½œä¸€å®šæ‰§è¡Œ

### 2. **å¼‚å¸¸å®¹é”™æœºåˆ¶**  
- æ¸…ç†å¤±è´¥ä¸å½±å“ä¸»ä¸šåŠ¡æµç¨‹
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•
- ä¼˜é›…çš„å¼‚å¸¸å¤„ç†

### 3. **æ‰¹é‡æ¸…ç†æœºåˆ¶**
- å®šæœŸæ¸…ç†å¯èƒ½é—ç•™çš„æ—§æ–‡ä»¶
- æŒ‰æ–‡ä»¶å¹´é¾„å’Œå‰ç¼€è¿‡æ»¤
- ç³»ç»Ÿå…³é—­æ—¶è‡ªåŠ¨æ‰§è¡Œæ¸…ç†

## æŠ€æœ¯å®ç°

### 1. VolcengineTOSSimpleç±»å¢å¼º

#### æ–°å¢æ–¹æ³•ï¼š

```python
def delete_file(self, object_key: str) -> bool:
    """
    ä»TOSåˆ é™¤æ–‡ä»¶
    
    Args:
        object_key: è¦åˆ é™¤çš„å¯¹è±¡é”®å
        
    Returns:
        bool: åˆ é™¤æ˜¯å¦æˆåŠŸ
    """

def delete_file_by_url(self, file_url: str) -> bool:
    """
    æ ¹æ®TOSæ–‡ä»¶URLåˆ é™¤æ–‡ä»¶
    
    Args:
        file_url: TOSæ–‡ä»¶çš„å®Œæ•´URL
        
    Returns:
        bool: åˆ é™¤æ˜¯å¦æˆåŠŸ
    """
```

#### ç‰¹æ€§ï¼š
- âœ… å®Œå–„çš„é”™è¯¯å¤„ç†ï¼ˆTosClientError, TosServerErrorï¼‰
- âœ… è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
- âœ… è‡ªåŠ¨URLè§£æå’Œobject_keyæå–
- âœ… è¿”å›æ˜ç¡®çš„æˆåŠŸ/å¤±è´¥çŠ¶æ€

### 2. IntegratedPipelineèµ„æºè·Ÿè¸ª

#### èµ„æºè·Ÿè¸ªå˜é‡ï¼š
```python
# TOSèµ„æºè·Ÿè¸ª
tos_client = None           # TOSå®¢æˆ·ç«¯å®ä¾‹
uploaded_file_url = None    # ä¸Šä¼ çš„æ–‡ä»¶URL
need_cleanup_tos = False    # æ˜¯å¦éœ€è¦æ¸…ç†æ ‡è®°
```

#### æ¸…ç†æœºåˆ¶ï¼š
```python
try:
    # ä¸»å¤„ç†é€»è¾‘
    # ...ä¸Šä¼ æ–‡ä»¶åˆ°TOS...
    uploaded_file_url = audio_url
    need_cleanup_tos = True
    # ...åç»­å¤„ç†...
    
except Exception as e:
    # é”™è¯¯å¤„ç†
    return ProcessingResult(success=False, ...)
    
finally:
    # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œæ¸…ç†
    self._cleanup_tos_resources(tos_client, uploaded_file_url, need_cleanup_tos)
```

### 3. æ™ºèƒ½èµ„æºæ¸…ç†æ–¹æ³•

```python
def _cleanup_tos_resources(self, tos_client, uploaded_file_url, need_cleanup):
    """æ¸…ç†TOSèµ„æº"""
    if not need_cleanup or not uploaded_file_url:
        return
        
    try:
        if tos_client:
            success = tos_client.delete_file_by_url(uploaded_file_url)
            if success:
                print("âœ… TOSæ–‡ä»¶æ¸…ç†æˆåŠŸ")
            else:
                print("âš ï¸ TOSæ–‡ä»¶æ¸…ç†å¤±è´¥ï¼Œä½†ä¸å½±å“ä¸»æµç¨‹")
    except Exception as e:
        # æ¸…ç†å¤±è´¥ä¸åº”è¯¥å½±å“ä¸»æµç¨‹ï¼Œåªè®°å½•é”™è¯¯
        print(f"âš ï¸ TOSèµ„æºæ¸…ç†å¼‚å¸¸: {e}")
    finally:
        # ç¡®ä¿å…³é—­TOSå®¢æˆ·ç«¯
        if tos_client:
            tos_client.close()
```

### 4. æ‰¹é‡æ¸…ç†åŠŸèƒ½

```python
def cleanup_orphaned_tos_files(self, prefix="audio/", max_age_hours=24):
    """æ¸…ç†é—ç•™çš„TOSæ–‡ä»¶"""
    # åˆ—å‡ºæŒ‡å®šå‰ç¼€çš„æ‰€æœ‰å¯¹è±¡
    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¿‡æœŸ
    # æ‰¹é‡åˆ é™¤è¿‡æœŸæ–‡ä»¶
    # è¿”å›æ¸…ç†ç»Ÿè®¡ä¿¡æ¯
```

#### ç‰¹æ€§ï¼š
- ğŸ• æŒ‰æ–‡ä»¶å¹´é¾„è¿‡æ»¤ï¼ˆé»˜è®¤24å°æ—¶ï¼‰
- ğŸ“‚ æŒ‰å‰ç¼€è¿‡æ»¤ï¼ˆé»˜è®¤"audio/"ï¼‰
- ğŸ“Š è¿”å›è¯¦ç»†çš„æ¸…ç†ç»Ÿè®¡
- ğŸ›¡ï¸ å®Œå–„çš„å¼‚å¸¸å¤„ç†
- ğŸ”„ ç³»ç»Ÿå…³é—­æ—¶è‡ªåŠ¨æ‰§è¡Œ

## ä½¿ç”¨æ–¹å¼

### 1. è‡ªåŠ¨æ¸…ç†ï¼ˆæ¨èï¼‰

æ­£å¸¸ä½¿ç”¨IntegratedPipelineï¼Œèµ„æºä¼šè‡ªåŠ¨æ¸…ç†ï¼š

```python
pipeline = IntegratedPipeline()
job_id = pipeline.process_file("input.mp3", "en")  # TOSæ–‡ä»¶ä¼šè‡ªåŠ¨æ¸…ç†
```

### 2. æ‰‹åŠ¨æ‰¹é‡æ¸…ç†

```python
pipeline = IntegratedPipeline()

# æ¸…ç†24å°æ—¶ä»¥ä¸Šçš„audioæ–‡ä»¶
stats = pipeline.cleanup_orphaned_tos_files()

# æ¸…ç†1å°æ—¶ä»¥ä¸Šçš„æ‰€æœ‰æ–‡ä»¶
stats = pipeline.cleanup_orphaned_tos_files(prefix="", max_age_hours=1)

print(f"æ‰¾åˆ°: {stats['found']}, åˆ é™¤: {stats['deleted']}, å¤±è´¥: {stats['failed']}")
```

### 3. ç›´æ¥ä½¿ç”¨TOSå®¢æˆ·ç«¯

```python
from services.providers.volcengine_tos_simple import VolcengineTOSSimple

tos_client = VolcengineTOSSimple.from_env()

# åˆ é™¤å•ä¸ªæ–‡ä»¶
success = tos_client.delete_file("audio/test_file.mp3")

# é€šè¿‡URLåˆ é™¤
success = tos_client.delete_file_by_url("https://bucket.endpoint.com/audio/file.mp3")

tos_client.close()
```

## å®‰å…¨ä¿éšœ

### 1. **ä¸šåŠ¡è¿ç»­æ€§**
- æ¸…ç†å¤±è´¥ä¸ä¼šä¸­æ–­ä¸»ä¸šåŠ¡æµç¨‹
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—ä¾¿äºé—®é¢˜è¯Šæ–­
- å¼‚å¸¸æƒ…å†µä¸‹çš„ä¼˜é›…é™çº§

### 2. **èµ„æºä¿æŠ¤**
- åŸºäºæ–‡ä»¶å¹´é¾„çš„å®‰å…¨è¿‡æ»¤
- æ˜ç¡®çš„å‰ç¼€é™åˆ¶é¿å…è¯¯åˆ 
- åˆ é™¤å‰çš„ç¡®è®¤æœºåˆ¶

### 3. **æ“ä½œå®¡è®¡**
- å®Œæ•´çš„æ“ä½œæ—¥å¿—
- æ¸…ç†ç»Ÿè®¡ä¿¡æ¯
- é”™è¯¯è¯¦æƒ…è®°å½•

## æµ‹è¯•éªŒè¯

### 1. å•å…ƒæµ‹è¯•
- âœ… TOSæ–‡ä»¶åˆ é™¤åŠŸèƒ½
- âœ… URLè§£æå’Œé”®åæå–
- âœ… èµ„æºæ¸…ç†æµç¨‹
- âœ… å¼‚å¸¸å¤„ç†æœºåˆ¶

### 2. é›†æˆæµ‹è¯•
- âœ… å®Œæ•´å¤„ç†æµç¨‹çš„èµ„æºæ¸…ç†
- âœ… å¼‚å¸¸æƒ…å†µä¸‹çš„æ¸…ç†è¡Œä¸º
- âœ… æ‰¹é‡æ¸…ç†åŠŸèƒ½

### 3. æµ‹è¯•è„šæœ¬
- `scripts/test_tos_cleanup.py` - å®Œæ•´åŠŸèƒ½æµ‹è¯•
- `scripts/test_tos_cleanup_simple.py` - æ ¸å¿ƒé€»è¾‘æµ‹è¯•

## æ€§èƒ½å½±å“

### 1. **å¤„ç†å¼€é”€**
- åˆ é™¤æ“ä½œï¼š< 100ms per file
- æ‰¹é‡æ¸…ç†ï¼šå–å†³äºæ–‡ä»¶æ•°é‡
- ä¸å½±å“ä¸»å¤„ç†æµç¨‹æ€§èƒ½

### 2. **ç½‘ç»œå¼€é”€**
- æ¯ä¸ªæ–‡ä»¶1æ¬¡DELETEè¯·æ±‚
- æ‰¹é‡æ¸…ç†æ—¶çš„LISTè¯·æ±‚
- å¯é…ç½®çš„è¶…æ—¶å’Œé‡è¯•æœºåˆ¶

## é…ç½®é€‰é¡¹

### ç¯å¢ƒå˜é‡ï¼ˆå¿…éœ€ï¼‰
```bash
VOLCENGINE_ACCESS_KEY=your_access_key
VOLCENGINE_SECRET_KEY=your_secret_key
TOS_ENDPOINT=tos-cn-beijing.volces.com
TOS_REGION=cn-beijing
TOS_BUCKET=your_bucket_name
```

### å¯è°ƒå‚æ•°
- `max_age_hours`: æ–‡ä»¶ä¿ç•™æ—¶é—´ï¼ˆé»˜è®¤24å°æ—¶ï¼‰
- `prefix`: æ¸…ç†æ–‡ä»¶å‰ç¼€ï¼ˆé»˜è®¤"audio/"ï¼‰
- `max_keys`: å•æ¬¡åˆ—å‡ºçš„æœ€å¤§æ–‡ä»¶æ•°ï¼ˆé»˜è®¤1000ï¼‰

## æœ€ä½³å®è·µ

### 1. **ç”Ÿäº§ç¯å¢ƒ**
- è®¾ç½®åˆé€‚çš„æ–‡ä»¶ä¿ç•™æ—¶é—´ï¼ˆå»ºè®®1-24å°æ—¶ï¼‰
- å®šæœŸæ‰§è¡Œæ‰¹é‡æ¸…ç†ï¼ˆå¦‚æ¯æ—¥å‡Œæ™¨ï¼‰
- ç›‘æ§æ¸…ç†æ—¥å¿—å’Œç»Ÿè®¡ä¿¡æ¯

### 2. **å¼€å‘ç¯å¢ƒ**
- ä½¿ç”¨è¾ƒçŸ­çš„ä¿ç•™æ—¶é—´ï¼ˆå¦‚1å°æ—¶ï¼‰
- é¢‘ç¹æ‰§è¡Œæ‰¹é‡æ¸…ç†é¿å…ç§¯ç´¯
- å¼€å¯è¯¦ç»†æ—¥å¿—ä¾¿äºè°ƒè¯•

### 3. **æ•…éšœæ¢å¤**
- æ¸…ç†å¤±è´¥æ—¶æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œæƒé™
- å¯æ‰‹åŠ¨æ‰§è¡Œæ‰¹é‡æ¸…ç†å¤„ç†ç§¯å‹æ–‡ä»¶
- é‡è¦æ–‡ä»¶å»ºè®®è®¾ç½®è¾ƒé•¿ä¿ç•™æ—¶é—´

## ç›‘æ§æŒ‡æ ‡

### 1. **æ¸…ç†ç»Ÿè®¡**
- æ¯æ—¥æ¸…ç†æ–‡ä»¶æ•°é‡
- æ¸…ç†æˆåŠŸ/å¤±è´¥æ¯”ä¾‹
- æ¸…ç†æ“ä½œè€—æ—¶

### 2. **å­˜å‚¨æŒ‡æ ‡**
- TOSå­˜å‚¨ç©ºé—´ä½¿ç”¨é‡
- ä¸´æ—¶æ–‡ä»¶ç§¯ç´¯æƒ…å†µ
- å­˜å‚¨è´¹ç”¨è¶‹åŠ¿

### 3. **é”™è¯¯ç›‘æ§**
- æ¸…ç†å¤±è´¥é¢‘ç‡
- ç½‘ç»œè¶…æ—¶æ¬¡æ•°
- æƒé™é”™è¯¯ç»Ÿè®¡

## æ€»ç»“

æ­¤è§£å†³æ–¹æ¡ˆå½»åº•è§£å†³äº†TOSèµ„æºæ³„æ¼é—®é¢˜ï¼Œæä¾›äº†ï¼š

- ğŸ¯ **å³æ—¶æ¸…ç†**ï¼šå¤„ç†å®Œæˆç«‹å³åˆ é™¤ä¸´æ—¶æ–‡ä»¶
- ğŸ›¡ï¸ **å¼‚å¸¸å®‰å…¨**ï¼šæ¸…ç†å¤±è´¥ä¸å½±å“ä¸»ä¸šåŠ¡
- ğŸ§¹ **æ‰¹é‡ç»´æŠ¤**ï¼šå®šæœŸæ¸…ç†é—ç•™æ–‡ä»¶
- ğŸ“Š **å®Œæ•´ç›‘æ§**ï¼šè¯¦ç»†çš„æ“ä½œæ—¥å¿—å’Œç»Ÿè®¡
- âš¡ **é«˜æ€§èƒ½**ï¼šæœ€å°çš„æ€§èƒ½å¼€é”€
- ğŸ”§ **æ˜“ç»´æŠ¤**ï¼šç®€å•çš„é…ç½®å’Œä½¿ç”¨

ç°åœ¨å¯ä»¥å®‰å¿ƒä½¿ç”¨TOSå­˜å‚¨æœåŠ¡ï¼Œä¸ç”¨æ‹…å¿ƒèµ„æºæ³„æ¼é—®é¢˜ï¼